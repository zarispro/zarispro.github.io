!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).km=t()}(this,function(){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function t(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function d(i){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?t(Object(a),!0).forEach(function(e){var t,n;t=i,e=a[n=e],n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(a,e))})}return i}var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(e,t){return e(t={exports:{}},t.exports),t.exports}var o=e(function(e){var t,n,o;t=r,n=-1,o={onVisible:function(n){var e=o.isSupported();if(!e||!o.hidden())return n(),e;var i=o.change(function(e,t){o.hidden()||(o.unbind(i),n())});return i},change:function(e){if(!o.isSupported())return!1;var t=n+=1;return o._callbacks[t]=e,o._listen(),t},unbind:function(e){delete o._callbacks[e]},afterPrerendering:function(n){var e=o.isSupported(),i="prerender";if(!e||i!=o.state())return n(),e;var a=o.change(function(e,t){i!=t&&(o.unbind(a),n())});return a},hidden:function(){return!(!o._doc.hidden&&!o._doc.webkitHidden)},state:function(){return o._doc.visibilityState||o._doc.webkitVisibilityState||"visible"},isSupported:function(){return void 0!==o._doc.hidden||void 0!==o._doc.webkitHidden},_doc:document||{},_callbacks:{},_change:function(e){var t,n=o.state();for(t in o._callbacks)o._callbacks[t].call(o._doc,e,n)},_listen:function(){var e,t;o._init||(e="visibilitychange",o._doc.webkitVisibilityState&&(e="webkit"+e),t=function(){o._change.apply(o,arguments)},o._doc.addEventListener?o._doc.addEventListener(e,t):o._doc.attachEvent(e,t),o._init=!0)}},e.exports?e.exports=o:t.Visibility=o}),m=e(function(e){function t(o){return o.every=function(e,t,n){o._time(),n||(n=t,t=null);var i=a+=1;return o._timers[i]={visible:e,hidden:t,callback:n},o._run(i,!1),o.isSupported()&&o._listen(),i},o.stop=function(e){return!!o._timers[e]&&(o._stop(e),delete o._timers[e],!0)},o._timers={},o._time=function(){o._timed||(o._timed=!0,o._wasHidden=o.hidden(),o.change(function(){o._stopRun(),o._wasHidden=o.hidden()}))},o._run=function(e,t){var n,i=o._timers[e];if(o.hidden()){if(null===i.hidden)return;n=i.hidden}else n=i.visible;function a(){i.last=new Date,i.callback.call(r)}t?(t=new Date-i.last)<n?i.delay=setTimeout(function(){i.id=setInterval(a,n),a()},n-t):(i.id=setInterval(a,n),a()):i.id=setInterval(a,n)},o._stop=function(e){e=o._timers[e];clearInterval(e.id),clearTimeout(e.delay),delete e.id,delete e.delay},o._stopRun=function(e){var t=o.hidden(),n=o._wasHidden;if(t&&!n||!t&&n)for(var i in o._timers)o._stop(i),o._run(i,!t)},o}var r,a;r=window,a=-1,e.exports?e.exports=t(o):t(r.Visibility||o)}),s=null;function c(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return s=s||e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function h(e,t,n){t.uuid=c(),t.sign=window.km_config_sign||window.km_config&&window.km_config.sign||"",t.clienttime=window.km_config.startTime||parseInt((new Date).getTime()/1e3),t.referer=window.location.protocol+"//"+window.location.host+window.location.pathname,t=function(e){var t,n="";for(t in e)n+=""==n?t+"="+e[t]:"&"+t+"="+e[t];return n}(t),console.log(e,t),(new Image).src="".concat(n,"?").concat(t)}function l(e,t,n){t.plat=n,h(e,t,"https://capture.kugou.com/performance/report/v1/collect/fps")}function x(t){if(t.length<=2)return[];for(var e,n=[{index:0,slope:0}],i=1;i<t.length;i++){var a=(a=t[i],(e=t[i-1])[0]-a[0]==0?null:Math.abs((e[1]-a[1])/(e[0]-a[0])));null!==a&&n.push({index:i,slope:a})}for(var o=[],r=1;r<n.length;r++)o.push({index:n[r].index,diff:n[r].slope-n[r-1].slope});var s,c,l,u=(l=c=0,(s=o).forEach(function(e,t){e.diff==e.diff&&(0<t&&e.diff===s[t-1]||(c+=Math.abs(e.diff),l++))}),c/(l=0===l?1:l)),f=[];return o.forEach(function(e){Math.abs(e.diff)>=2.5*u&&f.push([e.index-1,t[e.index-1][1]])}),f}var p=new(function(){function e(){n(this,e),this.stack=new Map}return a(e,[{key:"emit",value:function(e,t){var n=this.stack.get(e);if(n)for(var i,a=0;a<n.length;a++)(i=n[a])(t),i.del&&(n.splice(a,1),a--)}},{key:"on",value:function(e,t){var n=this.stack.get(e);n||this.stack.set(e,n=[]),n.push(t)}},{key:"off",value:function(e,t,n){var i=this.stack.get(e);if(i){for(var a=0;a<i.length;a++)if(i[a]===t){if(n){t.del=!0;break}i.splice(a,1);break}0===i.length&&this.stack.delete(e)}}},{key:"clear",value:function(e){this.stack.delete(e)}}]),e}()),u=new Map;function v(){var e=window.km_config_sign||window.km_config&&window.km_config.sign;return e=/粉丝说/.test(e)?e.replace("_V2",""):e}function f(e,t,n){window.localStorage?(localStorage.setItem(e,JSON.stringify(t)),void 0!==n&&localStorage.setItem("".concat(e,"_timeout"),+new Date+n)):u.set(e,t)}window.innerHeight,new(function(){function t(){var e;n(this,t),v()&&(this.calc={total:0,count:0},this.dom=null,this.animationFrameHandler=0,this.lastFrameTimestamp=-1,this.frameList=[],this.framePointer={start:0,end:9},this.timeList=[],this.eventList=[],this.totalEventList=[],this.listenerList=["click","move"],this.running=!1,e=this.getDevice(),this.plat=this.getPlatNum(),this.device={browser:{click:"click",move:"mousemove"},web:{click:"touchstart",move:"touchmove"}}[e],this.reportList=[],this.installListener(),this.run())}return a(t,[{key:"run",value:function(){var t=this;if(!this.running){this.running=!0;try{cancelAnimationFrame(this.animationFrameHandler)}catch(e){}this.lastFrameTimestamp=+new Date,p.on("visibility",function(e){e.e;if("hidden"===e.state)return window.kmCallLcp=!1,void window.cancelAnimationFrame(t.animationFrameHandler);t.lastFrameTimestamp=+new Date,window.kmCallLcp=!0,window.cancelAnimationFrame(t.animationFrameHandler),t.lastFrameTimestamp=+new Date,n()});var n=function e(){if(!window.kmNoReport){if(!window.kmCallLcp)return t.animationFrameHandler=requestAnimationFrame(e),void(t.lastFrameTimestamp=+new Date);t.timeList.push(+new Date-t.lastFrameTimestamp),t.lastFrameTimestamp=+new Date,60<t.timeList.length&&(t.calcFrame(),t.isBlocking()),t.animationFrameHandler=requestAnimationFrame(e)}};n()}}},{key:"calcFrame",value:function(){for(;0<this.timeList.length;){var e=this.timeList.shift();e<1e3?(this.calc.total+=e,this.calc.count++):this.frameList.push({frameRate:1,sign:v()}),1e3<=this.calc.total&&(this.frameList.push({frameRate:this.calc.count,sign:v()}),this.calc.total-=1e3,this.calc.count=0)}}},{key:"isBlocking",value:function(){if(!(this.frameList.length<this.framePointer.end+1)){for(var t,e,n=this.frameList.slice(this.framePointer.start,this.framePointer.end),i=!1,a=0,o=0,r=!1,s=null,c=null,l=null,u=0;u<n.length;u++){var f=n[u].frameRate;if(s&&s!==n[u].sign&&(r=!0,c=s,l=n[u].sign),s=n[u].sign,f<4){i=!0;break}f=f<=20;if(f&&a++,4<=a){i=!0;break}if(f&&(-1==u-1?o++:o=1),3<=o){i=!0;break}}i?(this.frameList.splice(this.framePointer.start,this.framePointer.end),t={click:0,move:0},this.eventList.forEach(function(e){t[e]++}),e={largeOperate:10<this.eventList.length,click:t.click,move:t.move},r&&(e.pageChange=!0,e.lastPage=c,e.currentPage=l),this.reportList.push(e),this.eventList=[],this.report()):this.frameList.splice(this.framePointer.start,Math.floor(this.framePointer.end/2))}}},{key:"report",value:function(){var a,o,r,s=this;this._throttleReport||(this._throttleReport=(a=function(t){var e,n=s.reportList.splice(0,10),i={},a=[];for(e in n.forEach(function(e){if(e.pageChange){var t="".concat(e.lastPage.replace("|","-"),"|").concat(e.currentPage.replace("|","-"));return i[t]||(i[t]={count:0,page:t}),void i[t].count++}if(e.largeOperate)return a[1]||(a[1]={count:0,large_operate:1,click:e.click,move:e.move}),void a[1].count++;a[0]||(a[0]={count:0}),a[0].count++}),i)l(t,i[e],s.plat);a.forEach(function(e){l(t,e,s.plat)})},o=3e3,function(){for(var e=this,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];clearTimeout(r),r=setTimeout(function(){r=null,a.apply(e,[].concat(n))},o)})),this._throttleReport("km_fps")}},{key:"getDevice",value:function(){return/Android|webOS|iPhone|iPod|BlackBerry|ucweb|rv:1.2.3.4|midp/i.test(navigator.userAgent)?"web":"browser"}},{key:"getPlatNum",value:function(){return/Android/i.test(navigator.userAgent)?1005:1e3}},{key:"getDom",value:function(e){return this.dom=e||document.body,this.dom}},{key:"installListener",value:function(){var n,e=this;this.getDom()&&(this.uninstallAllListener(),(n=this).listenerList.forEach(function(t){e.dom.addEventListener(e.device[t],e["".concat(t,"Event")]=function(e){n.recordEvent(t),"move"===t&&(n.uninstallListener(t),setTimeout(function(){n.dom.addEventListener(n.device[t],n["".concat(t,"Event")])},300))})}))}},{key:"uninstallAllListener",value:function(){var t=this;this.listenerList.forEach(function(e){t.uninstallListener(e)})}},{key:"uninstallListener",value:function(e){this.getDom()&&this["".concat(e,"Event")]&&this.dom.removeEventListener(this.device[e],this["".concat(e,"Event")])}},{key:"recordEvent",value:function(e){this.eventList.push(e),this.totalEventList.push({event:e,timestamp:parseInt((new Date).getTime()/1e3)})}}]),t}());var w=function e(){return window.kmCallLcp?Promise.resolve():new Promise(function(e){setTimeout(function(){e()},50)}).then(e)};window.km_config=window.km_config||{},window.km_config&&window.km_config.resourceTime&&v()&&(!1 in window||w().then(function(){var e,t;window.kmNoReport||(e=window.performance.getEntriesByType("resource"),t=[],e.map(function(e){/webcollects|capture/.test(e.name)||500<e.duration&&t.push({name:encodeURIComponent(e.name),type:e.initiatorType,time:parseInt(e.duration)})}),t.forEach(function(e){(new Image).src="https://capture.kugou.com/performance/report/v1/collect/customize?sign=".concat(v(),"&key=fileload&time=").concat(e.time,"&name=").concat(e.name,"&type=").concat(e.type)}))}));var g=function(){function t(e){e=e.stayTimeCallback;n(this,t),this.stayTimeCallback=e,this.stayTime=0}return a(t,[{key:"run",value:function(){var e=this;this.stayTimeCallback&&(this.interval=m.every(1e3,function(){e.stayTime++,e.stayTimeCallback(e.stayTime)}))}},{key:"reset",value:function(){this.stayTime=0}},{key:"stop",value:function(){m.stop(this.interval)}},{key:"destory",value:function(){m.stop(this.interval)}}]),t}(),_=function(){function e(){n(this,e),this.init(),this.run()}return a(e,[{key:"init",value:function(){var e,t=this;this.pageStay?this.pageStay.reset():(this.pageStay=new g({stayTimeCallback:function(e){0<t.pageStay.stayTime%3||f("km_stay_time",{time:t.pageStay.stayTime},864e7)}}),this.pageStay.run(),(e=function(e){if(!window.localStorage)return u.get(e);var t=localStorage.getItem("".concat(e,"_timeout"));return t?0<+new Date-parseInt(t)?(localStorage.removeItem(e),localStorage.removeItem("".concat(e,"_timeout")),null):JSON.parse(localStorage.getItem(e)):localStorage.getItem(e)}("km_stay_time"))&&3<e.time&&(this.pageStay.stayTime=Number(e.time),this.report(),this.init()))}},{key:"run",value:function(){var t=this;p.on("visibility",function(e){e.e;"hidden"===e.state&&0!==t.pageStay.stayTime&&(t.report(),t.init())}),p.on("pageStatusNew",function(e){(4===e.status||2===e.status)&&0<t.pageStay.stayTime&&(t.report(),t.init())}),window.addEventListener("beforeunload",function(){t.report(),t.init()})}},{key:"report",value:function(){var e,t;f("km_stay_time",{time:0},864e7),e="km_stay_time",t={time:parseInt(this.pageStay.stayTime)},h(e,t,"https://capture.kugou.com/performance/report/v1/collect/stay_time")}}]),e}(),y=0,k=0,P=+new Date,D=null,j=+new Date,O=document.documentElement.outerHTML.length,b=new Map;try{var L=function(e){var t=e.event,e=e.xhr;p.emit(t,e)},S=window.XMLHttpRequest;setTimeout(function(){y=!1},1500),window.XMLHttpRequest=function(){var e=new S;return e.addEventListener("abort",function(){L({xhr:this,event:"ajaxAbort"})},!1),e.addEventListener("error",function(){L({xhr:this,event:"ajaxError"})},!1),e.addEventListener("load",function(){L({xhr:this,event:"ajaxLoad"})},!1),e.addEventListener("loadstart",function(){L({xhr:this,event:"ajaxLoadStart"})},!1),e.addEventListener("progress",function(){L({xhr:this,event:"ajaxProgress"})},!1),e.addEventListener("timeout",function(){L({xhr:this,event:"ajaxTimeout"})},!1),e.addEventListener("loadend",function(){L({xhr:this,event:"ajaxLoadEnd"})},!1),e.addEventListener("readystatechange",function(){L({xhr:this,event:"ajaxReadyStateChange"})},!1),e}}catch(e){}function T(e){2<=y?b.clear():b.get(e._kmid)&&(y++,b.delete(e._kmid),P=+new Date)}p.on("ajaxReadyStateChange",function(e){return 1===e.readyState&&y<2?(e._kmid=+new Date,b.get(e._kmid)&&(e._kmid+=Math.random()),void b.set(e._kmid,!0)):void(4===e.readyState&&T(e))}),p.on("ajaxAbort",function(e){T(e)}),p.on("ajaxError",function(e){T(e)}),p.on("ajaxTimeout",function(e){T(e)}),window.kmRequestListener=function(e,t){1===e||2<=k||(k++,D=+new Date)};var E,I,M,R,w=(E={dot:[5,10,20],cutoff:30},I=document.body,(w=new MutationObserver(function(e,t){t.disconnect(),j=+new Date})).observe(I,{attributes:!0,childList:!0,characterData:!1}),M=w,R=C(),window.km_config?window.km_config.startTime=R:window.km_config={startTime:R},{init:function(){var e,a,o,r,s,c,l,t,n,i,u,f=!0;if(window.km_config&&window.km_config.sample&&(1===(e=window.km_config.sample)||Math.floor(Math.random()*e+1)===parseInt(e/2)?f=!0:(f=!1,window.kmNoReport=!0,window.kmCallLcp=!0)),f){try{Promise.all([(a={fluency:0},o=R,c=s=r=0,new Promise(function(i){return function n(){requestAnimationFrame(function(){var e,t;return++r%60==0&&s<5&&(s++,t=(e=Date.now())-o,o=e,c=t<=2e3?c+1:c,r=0),5===s?(a.fluency=c/5,void i(a)):void n()})}()})),F()]).then(function(e){window.kmCallLcp=!0;var t,n=H(e[1].doc_len,e[1].time);n&&(t={fluency:e[0].fluency,lcp:n.lcp,doc_len:n.doc_len,second_phase:n.second_phase,second_doc_len:n.second_doc_len,first_phase:n.first_phase,first_doc_len:n.first_doc_len},e=v(),n=(window.loadingTimeStart||C())-C(),/专辑-/.test(e)&&t.first_phase>n&&(t.lcp-=n,t.second_phase-=n,t.first_phase-=n),h("km_lcp",t,"https://capture.kugou.com/performance/report/v1/collect/lcp"),M&&M.disconnect())})}catch(e){console.log(e)}new _,m.change(function(e,t){p.emit("visibility",{e:e,state:t})}),window.kmEventListener=function(e){var t=e.event,e=e.args;p.emit(t,e)},window.km_config.hijackKgWebMobileCall&&window.Proxy&&window.Reflect&&(l=function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}4!==e.status&&2!==e.status||window.kmEventListener&&window.kmEventListener({event:"pageStatusNew",args:e})},(t=window.KgWebMobileCall||{}).pageStatusNew&&(t.pageStatusNewHijack=!0,n=t.pageStatusNew,t.pageStatusNew=function(e){n&&n(e),l(e)}),i=t,(u=function(){i=new Proxy(t,{get:function(e,t){var n=Reflect.get(e,t),i=Reflect.get(e,"pageStatusNewHijack");return"pageStatusNew"!==t||n||i?"pageStatusNew"===t&&n&&!i?(Reflect.set(e,"pageStatusNewHijack",!0),function(e){n&&n(e),l(e)}):n:l}})})(),Reflect.defineProperty(window,"KgWebMobileCall",{get:function(){return i},set:function(e){t=d(d({},t),e),u()}}))}}});function C(){return window.performance.timing&&"number"==typeof window.performance.timing.navigationStart?window.performance.timing.navigationStart:"number"==typeof window.performance.timeOrigin?parseInt(window.performance.timeOrigin):void 0}function F(){var o={doc_len:[0],time:[0]},r=0,s=0,c=+new Date;return new Promise(function(i){var a=setInterval(function(){var e=+new Date-c;if(c=+new Date,!(5<s&&s++%2!=0&&e<50)){var t=Date.now()-R,n=0!==window.performance.timing.domComplete;if(t>=1e3*E.cutoff||n)return i(o),void clearInterval(a);e=document.documentElement.outerHTML.length-O;1<o.doc_len.length&&o.doc_len[o.doc_len.length-2]===e?(n=o.doc_len.length-1,o.doc_len[n]=e,o.time[n]=t):(o.time.push(t),o.doc_len.push(e)),t>=1e3*E.dot[r]&&(i(o),clearInterval(a),r++,o={doc_len:[],time:[]})}},16)})}function H(e,t){var e=function(e,t){for(var n=[e[0]],i=[t[0]],a=1;a<e.length;a++)e[a]!==e[a-1]&&(n.push(e[a]),i.push(t[a]));return{times:n,vals:i}}(t,e),n=e.times,i=e.vals;if(0===i.length)return null;var a=[],o=-1,r=-1,s=-1,c=0,l=(P=(P=null!==D?D:P)<j?j:P)-C(),u=0;i.forEach(function(e,t){e=parseInt(e);o<e&&(s=o=e,r=n[u=t]),n[t]<=l&&(c=t),a.push([n[t],e])});var f=x(a);if(0<f.length&&(y=f.slice(0,3),u=y[y.length-1][0],r=n[u],s=i[u]),n[c+1]&&l-n[c]>n[c+1]-l&&(c+=1),n[c]&&r<n[c]&&Math.abs(s-i[c])/i[c]<=.05){r=n[u=c],s=i[u];for(var d=c;0<=d&&.99<=i[d]/i[c];d--)r=n[u=d],s=i[u]}var m=r,h=s,p=null;if(0===f.length){f[0]=[0];for(var v=1;v<i.length;v++)i[v]!==i[v-1]&&f.push([v])}for(var w=0;w<f.length;w++){var g=f[w][0];if(!(n[g]<r))break;m=n[g],h=i[g],p=g}if(null!==p)for(var _=p;0<=_&&Math.abs(i[_]-h)/h<=.01;_--)m=n[_],h=i[_],p=_;for(var y,k=m,b=h,L=null,S=0;S<f.length;S++){var T=f[S][0];if(!(n[T]<m))break;k=n[T],b=i[T],L=T}if(k===m&&(k=n[y=0<(y=p-1)?y:0],b=i[y],L=y),null!==L)for(var E=L;0<=E&&Math.abs(i[E]-b)/b<=.01;E--)k=n[E],b=i[E];return{lcp:r,doc_len:s+O,second_phase:m,second_doc_len:h+O,first_phase:k,first_doc_len:b+O}}return w.init(),w});
//# sourceMappingURL=km.js.map
