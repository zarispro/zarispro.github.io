!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self,e.lyric=t())}(this,function(){"use strict";var e={stringfyQueryString:function(e){if(!e)return"";var t=[];for(var i in e){var r=e[i];if(r instanceof Array)for(var n=0;n<r.length;++n)t.push(encodeURIComponent(i+"["+n+"]")+"="+encodeURIComponent(r[n]));else t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]))}return t.join("&")},ajax:function(e){var t=e.url,i=e.method,r=e.body,n=e.headers;return new Promise(function(e,a){var s=new XMLHttpRequest;s.open(i,t);for(var o in n){var c=n[o];s.setRequestHeader(o,c)}s.onreadystatechange=function(){4===s.readyState&&(s.status>=200&&s.status<300?e.call(void 0,s.responseText):s.status>=400&&a.call(void 0,s))},s.send(r)})},ajaxByjsonp:function(e){return new Promise(function(t,i){var r=document.getElementsByTagName("head")[0],n=document.createElement("script");r.appendChild(n),window[e.metadata.callback]=function(i){r.removeChild(n),window[e.metadata.callback]=null,t(i)},n.src=e.url})},autoAjax:function(e,t,i){var r=this;return new Promise(function(n,a){!i&&/\w+.kugou.com$/.test(location.host)||(e.metadata.format="jsonp",e.metadata.callback="lyrcallback"+Math.floor(1e4*Math.random()+500)),r.getInterFacePublic(e.metadata,"",function(s){var o=r.stringfyQueryString(s);e.url="https://m3ws.kugou.com/api/v1/krc/get_lyrics?"+o,i||!/\w+.kugou.com$/.test(location.host)?n(r.ajaxByjsonp(e)):t&&window.MiniApp?window.MiniApp.request({url:e.url,success:function(e){n(e.data)},fail:function(e){a(e)}}):n(r.ajax(e))})})},getLyrics:function(e){var t=this,i=e.hash,r=e.filename,n=e.timeLength,a=e.isKgMini,s=e.useJsonP,o=e.getInterFacePublic;return this.getInterFacePublic=o,new Promise(function(e,o){var c={keyword:r,hash:i,timelength:1e3*n};t.autoAjax({method:"get",metadata:c},a,s).then(function(t){var i="string"==typeof t?JSON.parse(t):t;if(1!=i.status||!i.data.lrc)throw"";e(i)}).catch(function(i){t.autoAjax({method:"get",metadata:c},a,s).then(function(t){var i="string"==typeof t?JSON.parse(t):t;if(1!=i.status||!i.data.lrc)throw i;e(i)}).catch(function(e){o(e)})})})}};return function(){function t(e){var t=e.getInterFacePublic,n=e.hash,a=e.filename,s=e.timeLength,o=e.lyricBoxId,c=e.noLycTip,l=e.isKgMini,h=e.useJsonP,u=e.isDebugger,d=e.useMove,m=e.noLandata,v=e.textLycTip;return new Promise(function(e,y){c=c||"酷狗音乐，让音乐改变世界！",i({hash:n,filename:a,timeLength:s,isKgMini:l,useJsonP:h,isDebugger:u,getInterFacePublic:t}).then(function(t){if(1==t.status&&t.data.lrc){if("txt"==t.data.fmt&&v)return y(v),void(document.getElementById(o).innerHTML='<div class="lyric_box_inner"><div class="nolrc">'+v+"</div></div>");if(t.data.lrc.split("[").length<3)document.getElementById(o).innerHTML='<div class="lyric_box_inner"><div class="nolrc">'+t.data.lrc.replace(/[\w\W]*\]/g,"").trim()+"</div></div>";else{var i=!1;if(t.data.landata.length>0&&!m){if(1==t.data.landata.length)i=t.data.landata[0].content,t.data.landata[0].type;else for(var n in t.data.landata)if(1==t.data.landata[n].type){i=t.data.landata[n].content,t.data.landata[n].type;break}i=i.substr(2,i.length-4).split("],[")}var a=new r({lyric:t.data.lrc,lyricBoxId:o,noLycTip:c,curRowClassName:"current",sideClassName:"side",separator:"[",landata:i,useMove:d,noLandata:m,isDebugger:u});e(a)}}else y(t),document.getElementById(o).innerHTML='<div class="lyric_box_inner"><div class="nolrc">'+c+"</div></div>"}).catch(function(e){document.getElementById(o).innerHTML='<div class="lyric_box_inner"><div class="nolrc">'+c+"</div></div>",y(e)})})}function i(t){return new Promise(function(i,r){if(!(t&&t.hash&&t.filename&&t.timeLength&&t.getInterFacePublic))return r("必传参数 hash, filename, timeLength, getInterFacePublic"),void console.error("必传参数 hash, filename, timeLength, getInterFacePublic");var n=localStorage.getItem("kg_lyric_"+t.hash),a=n?JSON.parse(n):{};!t.isDebugger&&a.data&&a.time>+new Date?i(a.data):e.getLyrics(t).then(function(e){e&&(i(e),a={data:e,time:+new Date+108e6},localStorage.setItem("kg_lyric_"+t.hash,JSON.stringify(a)))}).catch(function(e){r(e)})})}var r=function(){this.initialize.apply(this,arguments)};return r.prototype={arrLyricTime:[],arrLyric:[],initialize:function(e){this.lyricBoxId=e.lyricBoxId,this.landata=e.landata,this.useMove=e.useMove,e.useMove&&(this.useMoveMode=void 0==e.useMove.useMoveMode||e.useMove.useMoveMode),this.isDebugger=e.isDebugger,this.curRowClassName=e.curRowClassName,this.sideClassName=e.sideClassName,this.separator=e.separator,this.wordTime=-1,this.arrLyric=[],this.initArray(e.lyric),this.arrLyricTime=this.sort(this.arrLyricTime),this.setLyricTable(this.arrLyric),this.index=0,this.scrollT=0,this.showLyricLineFlag=!1,this.hideLineTimer=null,this.curPosition=0,this.setScroll()},initArray:function(e){for(var t,i=new RegExp("[0-9:.]*\\]","g"),r=e.split(this.separator),n=0,a=0,s=0;s<r.length;s++){var o=r[s].replace(/[\w\W]*\]/g,"").trim();if(""!==o)for(this.arrLyric[s-a]=o;null!==(t=i.exec(r[s]));){var c=this.parseSecond(t.toString().replace(/\[|\]/g,""));isNaN(c)||(this.arrLyricTime[n]=s-a+"|"+c,n++)}else a++}},IsLyricValid:function(){return this.arrLyricTime.length>0},updateLyrIndex:function(e,t){if(this.curPosition=e,t)this.index=-1;else if(this.isMove||this.showLyricLineFlag)return;clearInterval(this.wordTime);for(var i=this.arrLyricTime,r=0;r<i.length;r++){var n=i[r].split("|");if(0===r&&e<n[1])break;if(void 0===i[r+1]){this.setRow(n[0]);break}var a=i[r+1].split("|");if(e>=n[1]&&e<a[1]){this.setRow(n[0]);break}}},parseSecond:function(e){try{var t=e.split(":");return 60*parseInt(t[0],10)+parseFloat(t[1])}catch(e){return 0}},setLyricTable:function(e){for(var t="",i=0;i<e.length;i++)t+="<p><em><i>"+(this.isDebugger?this.arrLyricTime[i]:"")+e[i]+"</i>"+(this.landata?"<span>"+(this.landata[i]=this.landata[i])+"</span>":"")+"</em></p>";var r='<div class="lyric_box_inner"><div class="lyricContent" style="transform:translateY(0px);-webkit-transform:translateY(0px);-webkit-transition: all 0.3s ease-out;transition: all 0.3s ease-out;">'+t+"</div></div>";this.lyricBox=document.getElementById(this.lyricBoxId),this.lyricBox.innerHTML=r,this.lyricWrapper=document.querySelector("#"+this.lyricBoxId+" .lyricContent"),this.lyricBoxInner=document.querySelector("#"+this.lyricBoxId+" .lyric_box_inner"),this.useMove&&this.initMoveBind()},setRow:function(e){e!=this.index&&(this.index=e,this.setRowClass(this.index),this.setScroll())},setRowClass:function(e){for(var t=this,i=this.lyricBox.getElementsByTagName("p"),r=0;r<i.length;r++)i[r].className="";i[e]&&(i[e].className=t.curRowClassName,i[Number(e)-1]&&(i[Number(e)-1].className="uClass"),i[Number(e)+1]&&(i[Number(e)+1].className="dClass"),i[e].scrollWidth>i[e].offsetWidth&&(this.wordTime=setInterval(function(){i[e].scrollLeft++},1e3)))},setScroll:function(){var e=this.lyricBox.getElementsByTagName("p");if(e&&e[0]){var t=e[0].offsetHeight,i=e[0].offsetTop,r=this.lyricBox.clientHeight,n=Math.floor(r/t);if(0==n&&(console.warn("提示：当前设置的行高已经超过容器"),n=1),this.lyricBoxInner.style.height=n*t+"px",0==this.index)this.lyricWrapper.style.transform="translateY(0px)",this.lyricWrapper.style["-webkit-transform"]="translateY(0px)";else{var a=1==n?e[this.index].offsetTop:e[this.index].offsetTop-i-t*parseInt(n/2,10);n%2==0&&(a+=t),this.scrollT=-(a<0?0:a),this.lyricWrapper.style.transform="translateY("+this.scrollT+"px)",this.lyricWrapper.style["-webkit-transform"]="translateY("+this.scrollT+"px)"}}},getScrollIndex:function(e){var t=this.lyricBox.getElementsByTagName("p");if(!t||!t[0])return 0;var i=t[0].offsetHeight,r=(t[0].offsetTop,this.lyricBox.clientHeight);if(e>=0)(a=Math.floor((r/2-e)/i))<0&&(a=0);else{var n=Math.abs(e)+r/2,a=Math.floor(Math.abs(Number(n))/i);a>this.arrLyric.length-1&&(a=this.arrLyric.length-1)}return a},getIndexTime:function(){var e=this.getScrollIndex(this.moveDanceY?this.moveDanceY:this.scrollT),t=this.arrLyricTime[e],i=t=t&&t.indexOf("|")>-1?t.split("|")[1]:0;t=Math.floor(t);var r=Math.floor(t/60),n=r;0==r&&(n="00"),r<10&&(n="0"+r);var a=t%60,s=a;return 0==a&&(s="00"),a<10&&(s="0"+a),{timeStr:n+":"+s,time:t,realTime:i,lyricIndex:e}},sort:function(e){for(var t=0;t<e.length-1;t++)for(var i=t+1;i<e.length;i++)if(parseFloat(e[t].split("|")[1])>parseFloat(e[i].split("|")[1])){var r=e[t];e[t]=e[i],e[i]=r}return e},initMoveBind:function(){var e=this;if(e.useMove.setMoveTimeCallback){var t=document.createElement("div");t.className="moveLyricLineWrap",t.innerHTML='\n        <span class="move-lyric-current-time">00:00</span>\n        <strong class="move-lyric-left-line"></strong>\n        <strong class="move-lyric-right-line"></strong>\n        <i class=\'move-lyric-play-icon\'></i>',this.lyricBox.appendChild(t),this.moveLyricLineWrapDom=document.querySelector("#"+this.lyricBoxId+" .moveLyricLineWrap"),t.addEventListener("click",function(){var t=e.getIndexTime();e.useMove.setMoveTimeCallback&&e.useMove.setMoveTimeCallback(t),e.hideLyricLine()},!1)}var i=function(t){if(!e.useMove||!e.useMoveMode)return void(e.useMove&&e.useMove.tapEventCallback&&e.useMove.tapEventCallback(e.useMoveMode));e.down_start_time=+new Date;var i=(t=window.event||t).clientY||t.targetTouches[0].pageY;e.startMoveY=i,e.isMove=!0,t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,e.dcBind(),e.lyricWrapper.style.transition="none",e.lyricWrapper.style["-webkit-transition"]="none"};this.lyricBoxInner.addEventListener("touchstart",i,!1)},dcBind:function(){var e=this,t=document,i=this.lyricWrapper.clientHeight,r=this.lyricBox.clientHeight,n=0,a=e.showLyricLineFlag&&e.moveDanceY?e.moveDanceY:e.scrollT,s=function i(r){e.isMove&&(+new Date-e.down_start_time<200&&e.useMove&&e.useMove.tapEventCallback&&(e.showLyricLineFlag?e.hideLyricLine():e.useMove.tapEventCallback&&e.useMove.tapEventCallback(e.useMoveMode)),e.isMove=!1,e.lyricWrapper.style.transition="all 0.3s ease-out",e.lyricWrapper.style["-webkit-transition"]="all 0.3s ease-out",t.removeEventListener("touchmove",o,!1),t.removeEventListener("touchend",i,!1),t.removeEventListener("touchcancel",i,!1),e.hideLineTimer=setTimeout(function(){e.hideLyricLine(),e.updateLyrIndex(e.curPosition,!0)},e.useMove.hideLineTime||2e3))},o=function(t){if(e.showLyricLineFlag||(e.setCurLineTime(),e.showLyricLine()),e.isMove&&e.showLyricLineFlag){if(t.targetTouches&&t.targetTouches.length>0){var s=t.targetTouches[0];n=Number(s.pageY)-Number(e.startMoveY),e.moveDanceY=Number(a+n),e.moveDanceY>=r/2?(e.moveDanceY=r/2,n=i-r/2):e.moveDanceY<-(i-r/2)&&(e.moveDanceY=-(i-r/2)),e.lyricWrapper.style.transform="translateY("+e.moveDanceY+"px)",e.lyricWrapper.style["-webkit-transform"]="translateY("+e.moveDanceY+"px)",e.setCurLineTime()}e.hideLineTimer&&clearTimeout(e.hideLineTimer)}};t.addEventListener("touchmove",o,!1),t.addEventListener("touchend",s,!1),t.addEventListener("touchcancel",s,!1)},setCurLineTime:function(){if(this.useMove.setMoveTimeCallback){var e=this.getIndexTime();document.querySelector("#"+this.lyricBoxId+" .move-lyric-current-time").innerHTML=e.timeStr}},hideLyricLine:function(){this.showLyricLineFlag=!1,this.moveDanceY=0,this.useMove.setMoveTimeCallback&&(this.moveLyricLineWrapDom.style.opacity="0",this.moveLyricLineWrapDom.style.left="-10000px")},showLyricLine:function(){this.showLyricLineFlag=!0,this.useMove.setMoveTimeCallback&&(this.moveLyricLineWrapDom.style.opacity="1",this.moveLyricLineWrapDom.style.left="0px")},toggleUseMoveMode:function(e){return void 0==e?(this.useMoveMode&&this.hideLyricLine(),this.useMoveMode=!this.useMoveMode,this.useMoveMode):(e?this.useMoveMode=!0:(this.hideLyricLine(),this.useMoveMode=!1),this.useMoveMode)}},{getLyric:i,setLyric:t}}()});
//# sourceMappingURL=lyric.min.js.map
